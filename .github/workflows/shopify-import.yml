name: Import Products from Multiple CSV Files

on:
  push:
    branches:
      - main
      - 'feature/*'
  workflow_dispatch:
    inputs:
      folder_path:
        description: 'Folder path to process CSV files'
        required: true
        default: 'product-data'
      specific_file:
        description: 'Specific CSV file to process (optional)'
        required: false
        default: ''
      process_all:
        description: 'Process all CSV files in folder'
        type: boolean
        required: false
        default: false

jobs:
  detect-changed-files:
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.changes.outputs.changed-files }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Detect changed CSV files
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          if [ "${{ github.event.inputs.process_all }}" = "true" ]; then
            FOUND_FILES=$(find ${{ github.event.inputs.folder_path }} -name '*.csv' 2>/dev/null || echo "")
          elif [ -n "${{ github.event.inputs.specific_file }}" ]; then
            FOUND_FILES="${{ github.event.inputs.specific_file }}"
          else
            FOUND_FILES=$(find ${{ github.event.inputs.folder_path }} -name '*.csv' 2>/dev/null || echo "")
          fi
          
          if [ -n "$FOUND_FILES" ]; then
            echo "changed-files=$FOUND_FILES" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi
        else
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep -E '\.csv$' | grep '^product-data/' || echo "")
          if [ -n "$CHANGED_FILES" ]; then
            echo "changed-files=$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi
        fi

  import-products:
    needs: detect-changed-files
    if: needs.detect-changed-files.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install numpy==1.26.4 pandas==2.2.3
        pip install -r requirements.txt
        
    - name: Run import script
      env:
        SHOPIFY_SHOP_DOMAIN: ${{ secrets.SHOPIFY_SHOP_DOMAIN }}
        SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        SHOPIFY_API_VERSION: "2024-01"  # NOT a secret - regular env var
        CHANGED_FILES: ${{ needs.detect-changed-files.outputs.changed-files }}
      run: |
        echo "ðŸš€ Starting import with files: $CHANGED_FILES"
        echo "ðŸ”§ Using API version: $SHOPIFY_API_VERSION"
        python main.py
      
    - name: Upload import results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: import-results-${{ github.run_number }}
        path: |
          logs/*.log
          product-data/**/*.csv
